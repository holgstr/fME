<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="fmeffects">
<title>Get started • fmeffects</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Get started">
<meta property="og:description" content="fmeffects">
<meta property="og:image" content="https://holgstr.github.io/fmeffects/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">fmeffects</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.3</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item">
  <a class="nav-link" href="../articles/fmeffects.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/fme_theory.html">Why FMEs?</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/holgstr/fmeffects/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Get started</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/holgstr/fmeffects/blob/HEAD/vignettes/fmeffects.Rmd" class="external-link"><code>vignettes/fmeffects.Rmd</code></a></small>
      <div class="d-none name"><code>fmeffects.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <code>fmeffects</code> package computes, aggregates, and
visualizes forward marginal effects (FMEs) for supervised machine
learning models. Put simply, an FME is the change in a model’s predicted
value for a given observation if the feature is changed by a certain
value. Read the <a href="https://holgstr.github.io/fmeffects/articles/fme_theory.html">article</a>
on how FMEs are computed or the methods <a href="https://link.springer.com/article/10.1007/s10618-023-00993-x" class="external-link">paper</a>
for more details. Our <a href="https://holgstr.github.io/fmeffects/">website</a> is the best way
to find all resources.</p>
<p>There are three main functions:</p>
<ul>
<li>
<code><a href="../reference/fme.html">fme()</a></code> computes FMEs for a given model, data, feature(s)
of interest, and step size(s).</li>
<li>
<code><a href="../reference/came.html">came()</a></code> can be applied subsequently to find subspaces of
the feature space where FMEs are more homogeneous.</li>
<li>
<code><a href="../reference/ame.html">ame()</a></code> provides an overview of the prediction function
w.r.t. each feature by using average marginal effects (AMEs).</li>
</ul>
<div class="section level3">
<h3 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h3>
<p>Let’s look at data from a bike sharing usage system in Washington,
D.C. (Fanaee-T and Gama, 2014). We are interested in predicting
<code>count</code> (the total number of bikes lent out to users).</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://holgstr.github.io/fmeffects/">fmeffects</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">bikes</span>, package <span class="op">=</span> <span class="st">"fmeffects"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">bikes</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Classes 'data.table' and 'data.frame':   727 obs. of  11 variables:</span></span>
<span><span class="co">##  $ season    : Factor w/ 4 levels "fall","spring",..: 2 2 2 2 2 2 2 2 2 2 ...</span></span>
<span><span class="co">##  $ year      : Factor w/ 2 levels "0","1": 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">##  $ month     : num  1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">##  $ holiday   : Factor w/ 2 levels "True","False": 2 2 2 2 2 2 2 2 2 2 ...</span></span>
<span><span class="co">##  $ weekday   : Factor w/ 7 levels "Sun","Mon","Tue",..: 7 1 2 3 4 5 6 7 1 2 ...</span></span>
<span><span class="co">##  $ workingday: Factor w/ 2 levels "True","False": 2 2 1 1 1 1 1 2 2 1 ...</span></span>
<span><span class="co">##  $ weather   : Factor w/ 3 levels "clear","misty",..: 1 2 1 1 1 2 1 2 1 1 ...</span></span>
<span><span class="co">##  $ temp      : num  8.2 16.4 5.74 4.92 7.38 6.56 8.2 6.56 3.28 4.92 ...</span></span>
<span><span class="co">##  $ humidity  : num  0.86 0.76 0.5 0.74 0.43 0.59 0.69 0.74 0.53 0.5 ...</span></span>
<span><span class="co">##  $ windspeed : num  0 13 13 9 13 ...</span></span>
<span><span class="co">##  $ count     : num  3 1 64 94 88 95 84 9 6 77 ...</span></span>
<span><span class="co">##  - attr(*, ".internal.selfref")=&lt;externalptr&gt;</span></span></code></pre>
<p>FMEs are a model-agnostic interpretation method, i.e., they can be
applied to any regression or (binary) classification model. Before we
can compute FMEs, we need a trained model. In addition to generic
<code>lm</code>-type models, the <code>fme</code> package supports 100+
models from the <code>mlr3</code>, <code>tidymodels</code> and
<code>caret</code> libraries. Let’s try a random forest using the
<code>ranger</code> algorithm:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3verse.mlr-org.com" class="external-link">mlr3verse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://imbs-hl.github.io/ranger/" class="external-link">ranger</a></span><span class="op">)</span></span>
<span><span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/as_task_regr.html" class="external-link">as_task_regr</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">bikes</span>, target <span class="op">=</span> <span class="st">"count"</span><span class="op">)</span></span>
<span><span class="va">forest</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">lrn</a></span><span class="op">(</span><span class="st">"regr.ranger"</span><span class="op">)</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span><span class="op">)</span></span></code></pre></div>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="numeric-feature-effects">Numeric Feature Effects<a class="anchor" aria-label="anchor" href="#numeric-feature-effects"></a>
</h2>
<p>FMEs can be used to compute feature effects for both numerical and
categorical features. This can be done with the <code><a href="../reference/fme.html">fme()</a></code>
function. The most common application is to compute the FME for a single
numerical feature, i.e., a univariate feature effect. The variable of
interest must be specified with the <code>features</code> argument. This
is a named list with the feature names and step lengths. The step length
is chosen to be the number deemed most useful for the purpose of
interpretation. Most of the time, this will be a unit change, e.g.,
<code>features = list(feature_name = 1)</code>. As the concept of
numerical FMEs extends to multivariate feature changes as well,
<code><a href="../reference/fme.html">fme()</a></code> can be asked to compute a multivariate feature
effect.</p>
<div class="section level3">
<h3 id="univariate-effects">Univariate Effects<a class="anchor" aria-label="anchor" href="#univariate-effects"></a>
</h3>
<p>Assume we are interested in the effect of temperature on bike sharing
usage. Specifically, we set the step size to 1 to investigate the FME of
an increase in temperature by 1 degree Celsius (°C). Thus, we compute
FMEs for <code>features = list("temp" = 1)</code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">effects</span> <span class="op">=</span> <span class="fu"><a href="../reference/fme.html">fme</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">forest</span>,</span>
<span>               data <span class="op">=</span> <span class="va">bikes</span>,</span>
<span>               features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>temp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>               ep.method <span class="op">=</span> <span class="st">"envelope"</span><span class="op">)</span></span></code></pre></div>
<p>Note that we have specified <code>ep.method = "envelope"</code>. This
means we exclude observations for which adding 1°C to the temperature
results in the temperature value falling outside the range of
<code>temp</code> in the data. Thereby, we reduce the risk of model
extrapolation.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">effects</span><span class="op">)</span></span></code></pre></div>
<p><img src="fmeffects_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<p>The black arrow indicates direction and magnitude of the step size.
The horizontal line is the average marginal effect (AME). The AME is
computed as a simple mean over all observation-wise FMEs. Therefore, on
average, the FME of a temperature increase of 1°C on bike sharing usage
is roughly 2.4. As can be seen, the observation-wise effects seem to
vary along the range of <code>temp</code>. While the FME tends to be
positive for lower temperature values (5-20°C), it turns negative for
higher temperature values (&gt;20°C).<br></p>
<p>We can extract relevant aggregate information from the
<code>effects</code> object:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">effects</span><span class="op">$</span><span class="va">ame</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 2.366779</span></span></code></pre>
<p>For a more in-depth analysis, we can inspect the FME of each
observation in the data (excluding extrapolation points):</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">effects</span><span class="op">$</span><span class="va">results</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Key: &lt;obs.id&gt;</span></span>
<span><span class="co">##    obs.id       fme</span></span>
<span><span class="co">##     &lt;int&gt;     &lt;num&gt;</span></span>
<span><span class="co">## 1:      1  2.674573</span></span>
<span><span class="co">## 2:      2  2.895425</span></span>
<span><span class="co">## 3:      3  5.898867</span></span>
<span><span class="co">## 4:      4 -1.429239</span></span>
<span><span class="co">## 5:      5  4.084969</span></span>
<span><span class="co">## 6:      6  4.704511</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="multivariate-effects">Multivariate Effects<a class="anchor" aria-label="anchor" href="#multivariate-effects"></a>
</h3>
<p>Multivariate feature effects can be considered when one is interested
in the combined effect of two or more numeric features. Let’s assume we
want to estimate the effect of a decrease in temperature by 3°C,
combined with a decrease in humidity by 10 percentage points, i.e., the
FME for <code>features = list(temp = -3, humidity = -0.1)</code>:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">effects2</span> <span class="op">=</span> <span class="fu"><a href="../reference/fme.html">fme</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">forest</span>,</span>
<span>               data <span class="op">=</span> <span class="va">bikes</span>,</span>
<span>               features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>temp <span class="op">=</span> <span class="op">-</span><span class="fl">3</span>, humidity <span class="op">=</span> <span class="op">-</span><span class="fl">0.1</span><span class="op">)</span>,</span>
<span>               ep.method <span class="op">=</span> <span class="st">"envelope"</span><span class="op">)</span></span></code></pre></div>
<p>For bivariate effects, we can plot the effects in a way similar to
univariate effects (for more than two features, we can plot only the
histogram of effects):</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">effects2</span><span class="op">)</span></span></code></pre></div>
<p><img src="fmeffects_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<p>The plot for bivariate FMEs uses a color scale to indicate direction
and magnitude of the estimated effect. We can see that FMEs tend to be
positive for days with high temperature and high humidity. Let’s check
the AME:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">effects2</span><span class="op">$</span><span class="va">ame</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] -2.687935</span></span></code></pre>
<p>It seems that a combined decrease in temperature by 3°C and humidity
by 10 percentage points seems to result in slightly lower bike sharing
usage (on average). However, a quick check of the standard deviation of
the FMEs implies that effects are highly heterogeneous:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">effects2</span><span class="op">$</span><span class="va">results</span><span class="op">$</span><span class="va">fme</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 24.08741</span></span></code></pre>
<p>Therefore, it could be interesting to move the interpretation of
feature effects from a global to a <a href="#regional-interpretations">regional perspective</a> via the
<code><a href="../reference/came.html">came()</a></code> function.</p>
</div>
<div class="section level3">
<h3 id="non-linearity-measure">Non-Linearity Measure<a class="anchor" aria-label="anchor" href="#non-linearity-measure"></a>
</h3>
<p>The non-linearity measure (NLM) is a complimentary tool to an FME.
Any numerical, observation-wise FME is prone to be misinterpreted as a
linear effect. To counteract this, the NLM quantifies the linearity of
the prediction function for a single observation and step size. A value
of 1 indicates linearity, a value of 0 or lower indicates non-linearity
(similar to R-squared, the NLM can take negative values). A detailed
explanation can be found in the <a href="https://link.springer.com/article/10.1007/s10618-023-00993-x" class="external-link">FME
methods paper</a>.</p>
<p>We can compute and plot NLMs alongside FMEs for univariate and
multivariate feature changes. Computing NLMs can be computationally
demanding, so we use <code>furrr</code> for parallelization. To
illustrate NLMs, let’s recompute the first example of an increase in
temperature by 1 degree Celsius (°C) on a subset of the bikes data:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">effects3</span> <span class="op">=</span> <span class="fu"><a href="../reference/fme.html">fme</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">forest</span>,</span>
<span>               data <span class="op">=</span> <span class="va">bikes</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">200</span>,<span class="op">]</span>,</span>
<span>               feature <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>temp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>               ep.method <span class="op">=</span> <span class="st">"envelope"</span>,</span>
<span>               compute.nlm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Similarly to the AME, we can extract an Average NLM (ANLM):</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">effects3</span><span class="op">$</span><span class="va">anlm</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.4648</span></span></code></pre>
<p>A value of 0.5 indicates that a linear effect can describe some but
not all of the change of the prediction function along the multivariate
feature step. This means we should be weary of interpreting the FME as a
linear effect.</p>
<p>If NLMs have been computed, they can be visualized alongside FMEs
using <code>with.nlm = TRUE</code>:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">effects3</span>, with.nlm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="fmeffects_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<p>Equivalently, let’s compute an example with bivariate FMEs with
NLMs:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">effects4</span> <span class="op">=</span> <span class="fu"><a href="../reference/fme.html">fme</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">forest</span>,</span>
<span>               data <span class="op">=</span> <span class="va">bikes</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">200</span>,<span class="op">]</span>,</span>
<span>               features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>temp <span class="op">=</span> <span class="op">-</span><span class="fl">3</span>, humidity <span class="op">=</span> <span class="op">-</span><span class="fl">0.1</span><span class="op">)</span>,</span>
<span>               ep.method <span class="op">=</span> <span class="st">"envelope"</span>,</span>
<span>               compute.nlm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">effects4</span>, bins <span class="op">=</span> <span class="fl">25</span>, with.nlm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="fmeffects_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
</div>
</div>
<div class="section level2">
<h2 id="categorical-effects">Categorical Effects<a class="anchor" aria-label="anchor" href="#categorical-effects"></a>
</h2>
<p>For a categorical feature, the FME of an observation is simply the
difference in predictions when changing the observed category of the
feature to the category specified in <code>features</code>. For
instance, one could be interested in the effect of rainy weather on the
bike sharing demand, i.e., the FME of changing the feature value of
<code>weather</code> to <code>rain</code> for observations where weather
is either <code>clear</code> or <code>misty</code>:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">effects5</span> <span class="op">=</span> <span class="fu"><a href="../reference/fme.html">fme</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">forest</span>,</span>
<span>              data <span class="op">=</span> <span class="va">bikes</span>,</span>
<span>              features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>weather <span class="op">=</span> <span class="st">"rain"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">effects5</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Forward Marginal Effects Object</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Step type:</span></span>
<span><span class="co">##   categorical</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Feature &amp; reference category:</span></span>
<span><span class="co">##   weather, rain</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Extrapolation point detection:</span></span>
<span><span class="co">##   none, EPs: 0 of 657 obs. (0 %)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Average Marginal Effect (AME):</span></span>
<span><span class="co">##   -55.3083</span></span></code></pre>
<p>Here, the AME of <code>rain</code> is -55. Therefore, while holding
all other features constant, a change to rainy weather can be expected
to reduce bike sharing usage by 55.<br>
For categorical feature effects, we can plot the empirical distribution
of the FMEs:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">effects5</span><span class="op">)</span></span></code></pre></div>
<p><img src="fmeffects_files/figure-html/unnamed-chunk-17-1.png" width="700"></p>
<div class="section level3">
<h3 id="interactions">Interactions<a class="anchor" aria-label="anchor" href="#interactions"></a>
</h3>
<p>In a similar way, we can consider interactions of categories from
different features. For example, consider the average combined effect of
a clear sky on the weekend, i.e., <code>weather = "clear"</code> and
<code>workingday = "False"</code>:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/fme.html">fme</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">forest</span>,</span>
<span>    data <span class="op">=</span> <span class="va">bikes</span>,</span>
<span>    features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>weather <span class="op">=</span> <span class="st">"clear"</span>, workingday <span class="op">=</span> <span class="st">"False"</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">ame</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] -174.8351</span></span></code></pre>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="model-overview-with-ames">Model Overview with AMEs<a class="anchor" aria-label="anchor" href="#model-overview-with-ames"></a>
</h2>
<p>For an informative overview of all feature effects in a model, we can
use the <code><a href="../reference/ame.html">ame()</a></code> function:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">overview</span> <span class="op">=</span> <span class="fu"><a href="../reference/ame.html">ame</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">forest</span>, data <span class="op">=</span> <span class="va">bikes</span><span class="op">)</span></span>
<span><span class="va">overview</span><span class="op">$</span><span class="va">results</span></span></code></pre></div>
<pre><code><span><span class="co">##       Feature step.size       AME      SD      0.25      0.75   n</span></span>
<span><span class="co">## 1      season    spring   -29.472 31.5101   -39.955   -5.5139 548</span></span>
<span><span class="co">## 2      season    summer    0.4772 22.5212   -9.0235   11.6321 543</span></span>
<span><span class="co">## 3      season      fall   11.7452 28.5851   -2.4282   34.1763 539</span></span>
<span><span class="co">## 4      season    winter   15.5793 24.6394    1.6525   26.2254 551</span></span>
<span><span class="co">## 5        year         0   -99.038 67.1788 -157.0608  -20.0628 364</span></span>
<span><span class="co">## 6        year         1   97.0566  60.521   21.9401  148.0847 363</span></span>
<span><span class="co">## 7       month         1    4.0814 13.3513   -1.2566     7.459 727</span></span>
<span><span class="co">## 8     holiday     False   -1.2178 21.6103   -9.1095    9.8232  21</span></span>
<span><span class="co">## 9     holiday      True   -13.738 25.3496  -32.6323    6.2019 706</span></span>
<span><span class="co">## 10    weekday       Sat  -55.0908 49.6534  -87.6489  -15.8843 622</span></span>
<span><span class="co">## 11    weekday       Sun  -85.1527 57.7791 -122.1504  -31.8105 622</span></span>
<span><span class="co">## 12    weekday       Mon   10.7224 29.2179   -8.4101   30.4207 623</span></span>
<span><span class="co">## 13    weekday       Tue   17.9396  25.728    1.1959   32.5073 625</span></span>
<span><span class="co">## 14    weekday       Wed   20.4025 23.1599    1.3386   32.8358 623</span></span>
<span><span class="co">## 15    weekday       Thu   19.4455 24.1105   -0.3097   33.4997 624</span></span>
<span><span class="co">## 16    weekday       Fri    1.7712 35.3088  -24.8956   29.5147 623</span></span>
<span><span class="co">## 17 workingday     False -204.1875 89.3882  -257.144 -142.4332 496</span></span>
<span><span class="co">## 18 workingday      True  161.0619 62.5733  118.9398  209.6916 231</span></span>
<span><span class="co">## 19    weather     clear   26.1983 41.7886    3.5991   25.9257 284</span></span>
<span><span class="co">## 20    weather     misty     3.023 32.8661   -9.1498     0.973 513</span></span>
<span><span class="co">## 21    weather      rain  -55.3083 53.0127  -94.4096    -5.481 657</span></span>
<span><span class="co">## 22       temp         1    2.3426  7.1269   -0.4294    4.5534 727</span></span>
<span><span class="co">## 23   humidity      0.01   -0.2749   2.626   -0.3249    0.3504 727</span></span>
<span><span class="co">## 24  windspeed         1    0.0052  2.4318   -0.1823    0.2318 727</span></span></code></pre>
<p>This computes the AME for each feature included in the model, with a
default step size of 1 for numeric features (or, 0.01 if their range is
smaller than 1). For categorical features, AMEs are computed for all
available categories. Alternatively, we can specify a subset of features
and step sizes using the <code>features</code> argument:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">overview</span> <span class="op">=</span> <span class="fu"><a href="../reference/ame.html">ame</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">forest</span>,</span>
<span>               data <span class="op">=</span> <span class="va">bikes</span>,</span>
<span>               features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>weather <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"rain"</span>, <span class="st">"clear"</span><span class="op">)</span>, humidity <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>,</span>
<span>               ep.method <span class="op">=</span> <span class="st">"envelope"</span><span class="op">)</span></span>
<span><span class="va">overview</span><span class="op">$</span><span class="va">results</span></span></code></pre></div>
<pre><code><span><span class="co">##    Feature step.size      AME       SD      0.25     0.75   n</span></span>
<span><span class="co">## 1  weather      rain -55.3083 53.01272 -94.40958 -5.48097 657</span></span>
<span><span class="co">## 2  weather     clear 26.19828 41.78861   3.59911 25.92567 284</span></span>
<span><span class="co">## 3 humidity       0.1 -7.75386 17.23894  -8.54966  1.32707 640</span></span></code></pre>
<p>Again, note that we advise to set <code>ep.method = "envelope"</code>
so we avoid model extrapolation.</p>
<hr>
</div>
<div class="section level2">
<h2 id="regional-interpretations">Regional Interpretations<a class="anchor" aria-label="anchor" href="#regional-interpretations"></a>
</h2>
<p>We can use <code><a href="../reference/came.html">came()</a></code> on a specific FME object to compute
subspaces of the feature space where FMEs are more homogeneous. Let’s
take the effect of a decrease in temperature by 3°C combined with a
decrease in humidity by 10 percentage points, and see if we can find
three appropriate subspaces.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">subspaces</span> <span class="op">=</span> <span class="fu"><a href="../reference/came.html">came</a></span><span class="op">(</span>effects <span class="op">=</span> <span class="va">effects2</span>, number.partitions <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">subspaces</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## PartitioningCtree of an FME object</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Method:  partitions = 3</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##    n      cAME  SD(fME)  </span></span>
<span><span class="co">##  718 -2.687935 24.08741 *</span></span>
<span><span class="co">##  649 -4.881628 21.90090  </span></span>
<span><span class="co">##   39  4.164823 18.36672  </span></span>
<span><span class="co">##   30 35.860363 38.43502  </span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## * root node (non-partitioned)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## AME (Global): -2.6879</span></span></code></pre>
<p>As can be seen, the CTREE algorithm was used to partition the feature
space into three subspaces. The standard deviation (SD) of FMEs is used
as a criterion to measure homogeneity in each subspace. We can see that
the SD is substantially smaller in two of the three subspaces when
compared to the root node, i.e., the global feature space. The
conditional AME (cAME) can be used to interpret how the expected FME
varies across the subspaces. Let’s visualize our results:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">subspaces</span><span class="op">)</span></span></code></pre></div>
<p><img src="fmeffects_files/figure-html/unnamed-chunk-22-1.png" width="700"></p>
<p>In this case, we get a decision tree that assigns observations to a
feature subspace according to the weather situation
(<code>weather</code>) and the day of the week (<code>weekday</code>).
The information contained in the boxes below the terminal nodes are
equivalent to the summary output and can be extracted from
<code>subspaces$results</code>. The difference in the cAMEs across the
groups means the expected ME is estimated to vary substantially in
direction and magnitude across the subspaces. For example, the cAME is
highest on rainy days. It turns negative on non-rainy days.</p>
<hr>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Fanaee-T, H. and Gama, J. (2014). Event labeling combining ensemble
detectors and background knowledge. Progress in Artificial Intelligence
2(2): 113–127</p>
<p>Vanschoren, J., van Rijn, J. N., Bischl, B. and Torgo, L. (2013).
Openml: networked science in machine learning. SIGKDD Explorations
15(2): 49–60</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Holger Löwe, Christian Scholbeck.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
